@page "{id:int}"
@model SteadyGrowth.Web.Areas.Admin.Pages.Academy.UpgradeRequests.DetailsModel
@{
    ViewData["Title"] = "Upgrade Request Details";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Request != null)
{
    <div class="row">
        <div class="col-lg-8">
            <!-- Request Details Card -->
            <div class="card card-flush mb-6 mb-xl-9">
                <div class="card-header">
                    <div class="card-title">
                        <h3 class="fw-bold m-0">Upgrade Request Details</h3>
                    </div>
                    <div class="card-toolbar">
                        @{
                            var statusClass = Model.Request.Status switch
                            {
                                SteadyGrowth.Web.Models.Entities.UpgradeRequestStatus.Pending => "badge-light-warning",
                                SteadyGrowth.Web.Models.Entities.UpgradeRequestStatus.Approved => "badge-light-success",
                                SteadyGrowth.Web.Models.Entities.UpgradeRequestStatus.Rejected => "badge-light-danger",
                                _ => "badge-light-secondary"
                            };
                        }
                        <span class="badge @statusClass fw-bold fs-6">@Model.Request.Status</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Request ID</label>
                        <div class="col-lg-8">
                            <span class="fw-bold fs-6 text-gray-800">#@Model.Request.Id</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Requested Package</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-bold fs-6 text-gray-800">@Model.Request.RequestedPackage.Name</span>
                            <div class="text-muted fs-7">$@Model.Request.RequestedPackage.Price.ToString("N2")</div>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Payment Method</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-bold fs-6 text-gray-800">@Model.Request.PaymentMethod</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Payment Details</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-semibold fs-6 text-gray-800">@(Model.Request.PaymentDetails ?? "No details provided")</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Requested Date</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-semibold fs-6 text-gray-800">@Model.Request.RequestedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</span>
                        </div>
                    </div>
                    @if (Model.Request.ProcessedAt.HasValue)
                    {
                        <div class="row mb-7">
                            <label class="col-lg-4 fw-semibold text-muted">Processed Date</label>
                            <div class="col-lg-8 fv-row">
                                <span class="fw-semibold fs-6 text-gray-800">@Model.Request.ProcessedAt.Value.ToString("MMMM dd, yyyy 'at' HH:mm")</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- User Information Card -->
            <div class="card card-flush mb-6 mb-xl-9">
                <div class="card-header">
                    <div class="card-title">
                        <h3 class="fw-bold m-0">User Information</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Full Name</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-bold fs-6 text-gray-800">@Model.Request.User.FirstName @Model.Request.User.LastName</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Email</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-semibold fs-6 text-gray-800">@Model.Request.User.Email</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Phone Number</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-semibold fs-6 text-gray-800">@(Model.Request.User.PhoneNumber ?? "Not provided")</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Current Package</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-semibold fs-6 text-gray-800">@(Model.Request.User.AcademyPackage?.Name ?? "Basic Package")</span>
                        </div>
                    </div>
                    <div class="row mb-7">
                        <label class="col-lg-4 fw-semibold text-muted">Join Date</label>
                        <div class="col-lg-8 fv-row">
                            <span class="fw-semibold fs-6 text-gray-800">@Model.Request.User.CreatedAt.ToString("MMMM dd, yyyy")</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Actions Card -->
            <div class="card card-flush mb-6 mb-xl-9">
                <div class="card-header">
                    <div class="card-title">
                        <h3 class="fw-bold m-0">Actions</h3>
                    </div>
                </div>
                <div class="card-body pt-0">
                    @if (Model.Request.Status == SteadyGrowth.Web.Models.Entities.UpgradeRequestStatus.Pending)
                    {
                        <div class="d-flex flex-column gap-5">
                            <form method="post" asp-page-handler="Approve" onsubmit="return confirm('Are you sure you want to approve this upgrade request? This will upgrade the user to the Premium Academy Package.')">
                                <input type="hidden" name="id" value="@Model.Request.Id" />
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="ki-duotone ki-check fs-2 me-2"></i>
                                    Approve Request
                                </button>
                            </form>
                            
                            <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                <i class="ki-duotone ki-cross fs-2 me-2"></i>
                                Reject Request
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="ki-duotone ki-information-5 fs-3x text-muted mb-3">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            <p class="text-muted">This request has already been processed.</p>
                        </div>
                    }

                    <div class="separator my-7"></div>
                    
                    <div class="d-flex flex-column gap-3">
                        <a asp-page="./Index" class="btn btn-light w-100">
                            <i class="ki-duotone ki-arrow-left fs-2 me-2"></i>
                            Back to All Requests
                        </a>
                        <a asp-page="./Pending" class="btn btn-light-primary w-100">
                            <i class="ki-duotone ki-time fs-2 me-2"></i>
                            View Pending Requests
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Reject Upgrade Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" asp-page-handler="Reject">
                    <div class="modal-body">
                        <input type="hidden" name="id" value="@Model.Request.Id" />
                        <p>Are you sure you want to reject the upgrade request from <strong>@Model.Request.User.FirstName @Model.Request.User.LastName</strong>?</p>
                        <div class="mb-3">
                            <label for="rejectionReason" class="form-label">Rejection Reason (Optional)</label>
                            <textarea class="form-control" id="rejectionReason" name="rejectionReason" rows="3" placeholder="Provide a reason for rejection..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Reject Request</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center py-10">
        <div class="text-center px-4">
            <img class="mw-100 mh-300px" alt="" src="~/themes/metronic/v8_2/assets/media/illustrations/sketchy-1/18.png">
        </div>
        <div class="text-center px-4">
            <h3 class="fs-2hx fw-bold mb-4">Request Not Found</h3>
            <div class="fw-semibold fs-6 text-gray-500 mb-7">The upgrade request you're looking for doesn't exist or has been removed.</div>
            <div class="mb-3">
                <a asp-page="./Index" class="btn btn-primary">Back to All Requests</a>
            </div>
        </div>
    </div>
}